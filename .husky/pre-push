#!/bin/sh
set -o pipefail

# Get list of files changed in commits being pushed (compared to remote)
# If remote doesn't exist yet, compare to HEAD~1
REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")

if [ -n "$REMOTE_BRANCH" ]; then
  CHANGED_FILES=$(git diff --name-only "$REMOTE_BRANCH"...HEAD)
else
  # No remote tracking branch, check commits that would be pushed
  CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD 2>/dev/null || git diff --name-only --cached)
fi

# Categorize changes
HAS_SRC_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^src/.*\.(ts|js)$' || true)
HAS_TEST_CHANGES=$(echo "$CHANGED_FILES" | grep -E '\.(test|spec)\.(ts|js)$' || true)
HAS_CONFIG_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^(package\.json|tsconfig\.json|tsup\.config\.ts|vitest\.config\.ts)' || true)

# Skip coverage if no source or test files changed
if [ -z "$HAS_SRC_CHANGES" ] && [ -z "$HAS_TEST_CHANGES" ]; then
  echo "‚ÑπÔ∏è  No source/test changes detected, skipping coverage tests"
  exit 0
fi

# Run tests for changed files (full coverage runs in CI)
echo "üß™ Running tests for changed files..."

# Get changed test files
CHANGED_TEST_FILES=$(echo "$CHANGED_FILES" | grep -E '\.test\.ts$' || true)

if [ -n "$CHANGED_TEST_FILES" ]; then
  echo "Running tests: $CHANGED_TEST_FILES"
  echo "$CHANGED_TEST_FILES" | tr '\n' ' ' | xargs bun vitest run --exclude tests/integration/ || exit 1
fi

# Get corresponding test files for changed source files
if [ -n "$HAS_SRC_CHANGES" ]; then
  SRC_TEST_FILES=""
  for src in $HAS_SRC_CHANGES; do
    test_file=$(echo "$src" | sed 's/\.ts$/.test.ts/')
    if [ -f "$test_file" ]; then
      SRC_TEST_FILES="$SRC_TEST_FILES $test_file"
    fi
  done

  if [ -n "$SRC_TEST_FILES" ]; then
    echo "Running tests for sources:$SRC_TEST_FILES"
    bun vitest run --exclude tests/integration/ $SRC_TEST_FILES || exit 1
  fi
fi

echo "‚úÖ Tests passed (full coverage runs in CI)"
