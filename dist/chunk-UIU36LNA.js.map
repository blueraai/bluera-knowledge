{"version":3,"sources":["../src/services/watch.service.ts","../src/utils/ignore-patterns.ts"],"sourcesContent":["import { watch, type FSWatcher } from 'chokidar';\nimport { normalizeGlobPatterns } from '../utils/ignore-patterns.js';\nimport type { IndexService } from './index.service.js';\nimport type { LanceStore } from '../db/lance.js';\nimport type { FileStore, RepoStore } from '../types/store.js';\n\nexport interface WatchServiceOptions {\n  ignorePatterns?: readonly string[];\n}\n\nexport class WatchService {\n  private readonly watchers: Map<string, FSWatcher> = new Map();\n  private readonly pendingTimeouts: Map<string, NodeJS.Timeout> = new Map();\n  private readonly indexService: IndexService;\n  private readonly lanceStore: LanceStore;\n  private readonly ignorePatterns: readonly string[];\n\n  constructor(\n    indexService: IndexService,\n    lanceStore: LanceStore,\n    options: WatchServiceOptions = {}\n  ) {\n    this.indexService = indexService;\n    this.lanceStore = lanceStore;\n    // Use shared utility to normalize patterns to glob format with defaults\n    this.ignorePatterns = normalizeGlobPatterns(options.ignorePatterns ?? []);\n  }\n\n  async watch(\n    store: FileStore | RepoStore,\n    debounceMs: number,\n    onReindex: (() => void) | undefined,\n    onError: (error: Error) => void\n  ): Promise<void> {\n    if (this.watchers.has(store.id)) {\n      return Promise.resolve(); // Already watching\n    }\n\n    let timeout: NodeJS.Timeout | null = null;\n\n    const watcher = watch(store.path, {\n      ignored: [...this.ignorePatterns],\n      persistent: true,\n      ignoreInitial: true,\n    });\n\n    const reindexHandler = (): void => {\n      if (timeout) clearTimeout(timeout);\n      timeout = setTimeout(() => {\n        this.pendingTimeouts.delete(store.id);\n        void (async (): Promise<void> => {\n          try {\n            await this.lanceStore.initialize(store.id);\n\n            // Try incremental indexing first if available, fall back to full indexing\n            let useFullReindex = true;\n            if (typeof this.indexService.indexStoreIncremental === 'function') {\n              const incrementalResult = await this.indexService.indexStoreIncremental(store);\n              if (incrementalResult.success) {\n                useFullReindex = false;\n              }\n            }\n\n            if (useFullReindex) {\n              await this.indexService.indexStore(store);\n            }\n\n            onReindex?.();\n          } catch (e) {\n            const error = e instanceof Error ? e : new Error(String(e));\n            onError(error);\n          }\n        })();\n      }, debounceMs);\n      this.pendingTimeouts.set(store.id, timeout);\n    };\n\n    watcher.on('all', reindexHandler);\n\n    watcher.on('error', (e) => {\n      const error = e instanceof Error ? e : new Error(String(e));\n      onError(error);\n    });\n\n    this.watchers.set(store.id, watcher);\n    return Promise.resolve();\n  }\n\n  async unwatch(storeId: string): Promise<void> {\n    // Clear any pending timeout to prevent timer leak\n    const pendingTimeout = this.pendingTimeouts.get(storeId);\n    if (pendingTimeout) {\n      clearTimeout(pendingTimeout);\n      this.pendingTimeouts.delete(storeId);\n    }\n\n    const watcher = this.watchers.get(storeId);\n    if (watcher) {\n      await watcher.close();\n      this.watchers.delete(storeId);\n    }\n  }\n\n  async unwatchAll(): Promise<void> {\n    for (const [id] of this.watchers) {\n      await this.unwatch(id);\n    }\n  }\n}\n","/**\n * Unified ignore pattern handling for consistent behavior across IndexService and WatchService.\n *\n * Pattern normalization ensures the same config patterns work identically whether used\n * for fs.readdir scanning (IndexService) or chokidar watching (WatchService).\n */\n\n/** Default directories to always ignore */\nexport const DEFAULT_IGNORE_DIRS = ['node_modules', '.git', '.bluera', 'dist', 'build'] as const;\n\n/**\n * Normalize patterns to standard glob format for chokidar and micromatch.\n *\n * Transformations:\n * - 'node_modules' → '** /node_modules/**' (directory anywhere in tree)\n * - 'node_modules/**' → '** /node_modules/**' (explicit directory pattern)\n * - '*.min.js' → '**\\/*.min.js' (extension pattern anywhere)\n * - '** /foo/**' → unchanged (already in glob format)\n *\n * @param patterns - User-provided patterns from config\n * @param includeDefaults - Whether to include DEFAULT_IGNORE_DIRS (default: true)\n */\nexport function normalizeGlobPatterns(\n  patterns: readonly string[],\n  includeDefaults = true\n): string[] {\n  const result: string[] = [];\n\n  // Add defaults first\n  if (includeDefaults) {\n    for (const dir of DEFAULT_IGNORE_DIRS) {\n      result.push(`**/${dir}/**`);\n    }\n  }\n\n  // Process user patterns\n  for (const pattern of patterns) {\n    if (pattern.startsWith('**/') && pattern.endsWith('/**')) {\n      // Already in glob format\n      result.push(pattern);\n    } else if (pattern.endsWith('/**')) {\n      // Directory pattern: 'foo/**' → '**/foo/**'\n      result.push(`**/${pattern}`);\n    } else if (pattern.startsWith('*.')) {\n      // Extension pattern: '*.min.js' → '**/*.min.js'\n      result.push(`**/${pattern}`);\n    } else if (!pattern.includes('/') && !pattern.includes('*')) {\n      // Simple directory name: 'node_modules' → '**/node_modules/**'\n      result.push(`**/${pattern}/**`);\n    } else {\n      // Keep as-is (might be a specific path pattern)\n      result.push(pattern);\n    }\n  }\n\n  return result;\n}\n\n/**\n * Parsed patterns optimized for fs.readdir scanning.\n */\nexport interface ScanningPatterns {\n  /** Directory names to skip during traversal (e.g., 'node_modules', '.git') */\n  dirs: Set<string>;\n  /** Predicate functions to test if a filename should be ignored (e.g., for '*.min.js') */\n  fileMatchers: Array<(filename: string) => boolean>;\n}\n\n/**\n * Parse patterns into structures optimized for fs.readdir filtering.\n *\n * This is more efficient than glob matching for directory traversal since\n * it allows early termination when encountering ignored directories.\n *\n * @param patterns - User-provided patterns from config\n * @param includeDefaults - Whether to include DEFAULT_IGNORE_DIRS (default: true)\n */\nexport function parseIgnorePatternsForScanning(\n  patterns: readonly string[],\n  includeDefaults = true\n): ScanningPatterns {\n  const dirs = new Set<string>();\n  const fileMatchers: Array<(filename: string) => boolean> = [];\n\n  // Add defaults first\n  if (includeDefaults) {\n    for (const dir of DEFAULT_IGNORE_DIRS) {\n      dirs.add(dir);\n    }\n  }\n\n  // Process user patterns\n  for (const pattern of patterns) {\n    if (pattern.startsWith('**/') && pattern.endsWith('/**')) {\n      // Glob format: '**/node_modules/**' → extract 'node_modules'\n      const inner = pattern.slice(3, -3);\n      if (!inner.includes('/') && !inner.includes('*')) {\n        dirs.add(inner);\n      }\n    } else if (pattern.endsWith('/**')) {\n      // Directory pattern: 'node_modules/**' → 'node_modules'\n      dirs.add(pattern.slice(0, -3));\n    } else if (pattern.startsWith('*.')) {\n      // Extension pattern: '*.min.js' → matches files ending with '.min.js'\n      const ext = pattern.slice(1); // Remove leading '*'\n      fileMatchers.push((filename) => filename.endsWith(ext));\n    } else if (!pattern.includes('/') && !pattern.includes('*')) {\n      // Simple directory name: 'node_modules' → treat as directory\n      dirs.add(pattern);\n    }\n    // Note: Complex patterns like 'src/**/*.test.ts' are not supported for scanning\n    // They would require full glob matching which defeats the purpose of fast scanning\n  }\n\n  return { dirs, fileMatchers };\n}\n"],"mappings":"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","names":[]}