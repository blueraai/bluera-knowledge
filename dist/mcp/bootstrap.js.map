{"version":3,"sources":["../../src/mcp/bootstrap.ts"],"sourcesContent":["#!/usr/bin/env node\n/**\n * MCP Server Bootstrap - installs dependencies before starting server.\n *\n * Uses only Node.js built-ins (no external dependencies required).\n * Self-locates plugin root via import.meta.url (doesn't rely on CLAUDE_PLUGIN_ROOT).\n *\n * This solves two issues:\n * 1. Bash path resolution broken - ${CLAUDE_PLUGIN_ROOT:-.} not expanded for bash\n * 2. Dependencies not installed - plugins installed via git clone without npm install\n *\n * IMPORTANT: MCP servers must NOT log to stderr - Claude Code treats stderr output\n * as an error and may mark the MCP server as failed. All logging goes to file.\n */\nimport { execSync } from 'node:child_process';\nimport { appendFileSync, existsSync, mkdirSync } from 'node:fs';\nimport { homedir } from 'node:os';\nimport { dirname, join } from 'node:path';\nimport { fileURLToPath } from 'node:url';\n\n// Logging helper - writes to file since MCP servers must NOT use stderr\n// (Claude Code treats stderr as error and may fail the server)\n// JSON format matches pino output for consistency\nconst logDir = join(homedir(), '.bluera', 'bluera-knowledge', 'logs');\nconst logFile = join(logDir, 'app.log');\n\nconst log = (msg: string, data?: Record<string, unknown>): void => {\n  try {\n    mkdirSync(logDir, { recursive: true });\n    const entry = {\n      time: new Date().toISOString(),\n      level: 'info',\n      module: 'bootstrap',\n      msg,\n      ...data,\n    };\n    appendFileSync(logFile, `${JSON.stringify(entry)}\\n`);\n  } catch {\n    // Silently fail - we cannot use stderr for MCP servers\n  }\n};\n\n// Self-locate plugin root from this file's path\n// dist/mcp/bootstrap.js -> plugin root (two directories up)\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\nconst pluginRoot = join(__dirname, '..', '..');\n\nlog('Bootstrap starting', { pluginRoot });\n\n// Install dependencies if node_modules is missing\nif (!existsSync(join(pluginRoot, 'node_modules'))) {\n  const hasBun = ((): boolean => {\n    try {\n      execSync('which bun', { stdio: 'ignore' });\n      return true;\n    } catch {\n      return false;\n    }\n  })();\n\n  const cmd = hasBun ? 'bun install --frozen-lockfile' : 'npm ci --silent';\n  log('Dependencies missing, installing', { hasBun, cmd });\n  execSync(cmd, { cwd: pluginRoot, stdio: 'inherit' });\n  log('Dependencies installed');\n} else {\n  log('Dependencies already installed');\n}\n\n// Now that dependencies are installed, import and run the server\n// Dynamic import required because @modelcontextprotocol/sdk wouldn't be available before install\nlog('Loading server module');\nconst { runMCPServer } = await import('./server.js');\n\nconst projectRoot = process.env['PROJECT_ROOT'];\nif (projectRoot === undefined) {\n  throw new Error('PROJECT_ROOT environment variable is required');\n}\n\nlog('Starting MCP server', { projectRoot, dataDir: process.env['DATA_DIR'] });\n\nawait runMCPServer({\n  dataDir: process.env['DATA_DIR'],\n  config: process.env['CONFIG_PATH'],\n  projectRoot,\n});\n"],"mappings":";;;AAcA,SAAS,gBAAgB;AACzB,SAAS,gBAAgB,YAAY,iBAAiB;AACtD,SAAS,eAAe;AACxB,SAAS,SAAS,YAAY;AAC9B,SAAS,qBAAqB;AAK9B,IAAM,SAAS,KAAK,QAAQ,GAAG,WAAW,oBAAoB,MAAM;AACpE,IAAM,UAAU,KAAK,QAAQ,SAAS;AAEtC,IAAM,MAAM,CAAC,KAAa,SAAyC;AACjE,MAAI;AACF,cAAU,QAAQ,EAAE,WAAW,KAAK,CAAC;AACrC,UAAM,QAAQ;AAAA,MACZ,OAAM,oBAAI,KAAK,GAAE,YAAY;AAAA,MAC7B,OAAO;AAAA,MACP,QAAQ;AAAA,MACR;AAAA,MACA,GAAG;AAAA,IACL;AACA,mBAAe,SAAS,GAAG,KAAK,UAAU,KAAK,CAAC;AAAA,CAAI;AAAA,EACtD,QAAQ;AAAA,EAER;AACF;AAIA,IAAM,aAAa,cAAc,YAAY,GAAG;AAChD,IAAM,YAAY,QAAQ,UAAU;AACpC,IAAM,aAAa,KAAK,WAAW,MAAM,IAAI;AAE7C,IAAI,sBAAsB,EAAE,WAAW,CAAC;AAGxC,IAAI,CAAC,WAAW,KAAK,YAAY,cAAc,CAAC,GAAG;AACjD,QAAM,UAAU,MAAe;AAC7B,QAAI;AACF,eAAS,aAAa,EAAE,OAAO,SAAS,CAAC;AACzC,aAAO;AAAA,IACT,QAAQ;AACN,aAAO;AAAA,IACT;AAAA,EACF,GAAG;AAEH,QAAM,MAAM,SAAS,kCAAkC;AACvD,MAAI,oCAAoC,EAAE,QAAQ,IAAI,CAAC;AACvD,WAAS,KAAK,EAAE,KAAK,YAAY,OAAO,UAAU,CAAC;AACnD,MAAI,wBAAwB;AAC9B,OAAO;AACL,MAAI,gCAAgC;AACtC;AAIA,IAAI,uBAAuB;AAC3B,IAAM,EAAE,aAAa,IAAI,MAAM,OAAO,aAAa;AAEnD,IAAM,cAAc,QAAQ,IAAI,cAAc;AAC9C,IAAI,gBAAgB,QAAW;AAC7B,QAAM,IAAI,MAAM,+CAA+C;AACjE;AAEA,IAAI,uBAAuB,EAAE,aAAa,SAAS,QAAQ,IAAI,UAAU,EAAE,CAAC;AAE5E,MAAM,aAAa;AAAA,EACjB,SAAS,QAAQ,IAAI,UAAU;AAAA,EAC/B,QAAQ,QAAQ,IAAI,aAAa;AAAA,EACjC;AACF,CAAC;","names":[]}